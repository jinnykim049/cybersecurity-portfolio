## Snort Rule Structure
Understanding the Snort rule format is essential for any blue and purple teamer.  The primary structure of the snort rule is shown below. 

(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 5.49.49 PM.png)

Each rule should have a type of action, protocol, source and destination IP, source and destination port and an option. 

Snort is in passive mode by default, so most of the time, I will use Snort as an IDS. 

## Snort features & rules
Before start playing with inline mode (to turn on IPS mode), I should be familiar with Snort features and rules to create efficient rules.   

The Snort rule structure is easy to understand but difficult to produce. Therefore, practice Snort rules and option details for different use cases is helpful. 

In this chapter, I will focus on two actions; 
"alert" for IDS mode and "reject" for IPS mode.

Note that Rules cannot be processed without a header. Rule options are "optional" parts. However, it is almost impossible to detect sophisticated attacks without using the rule options. 

*Action*
There are several actions for rules. The most common ones: 
- alert: Generate an alert and log the packet.
- log: Log the packet.
- drop: Block and log the packet.
- reject: Block the packet, log it and terminate the packet session.  

*Protocol* 
Protocol parameter identifies the type of the protocol that filtered for the rule.
Note: Snort2 supports only four protocols filters in the rules (IP, TCP, UDP and ICMP). However, I can detect the application flows using port numbers and options. For instance, if I want to detect FTP traffic, I cannot use the FTP keyword in the protocol field but filter the FTP traffic by investigating TCP traffic on port 21 (21: FTP port number).


# IP and Port Numbers 
These parameters below identify the source and destination IP addresses and associated port numbers filtered for the rule. 

- IP Filtering: alert icmp 192.168.1.56 any <> any any  (msg: "ICMP Packet From "; sid: 100001; rev:1;)
This rule will create an alert for each ICMP packet originating from the 192.168.1.56 IP address.

- Filter an IP range: alert icmp 192.168.1.0/24 any <> any any  (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
This rule will create an alert for each ICMP packet originating from the 192.168.1.0/24 subnet. 

- Filter multiple IP ranges: alert icmp [192.168.1.0/24, 10.1.1.0/24] any <> any any  (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
This rule will create an alert for each ICMP packet originating from the 192.168.1.0/24 and 10.1.1.0/24 subnets.

- Exclude IP addresses/ranges: alert icmp !192.168.1.0/24 any <> any any  (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
This rule will create an alert for each ICMP packet not originating from the 192.168.1.0/24 subnet.

- Port Filtering: alert tcp any any <> any 21  (msg: "FTP Port 21 Command Activity Detected"; sid: 100001; rev:1;)
This rule will create an alert for each TCP packet sent to port 21. 

- Exclude a specific port: alert tcp any any <> any !21  (msg: "Traffic Activity Without FTP Port 21 Command Channel"; sid: 100001; rev:1;)
This rule will create an alert for each TCP packet not sent to port 21. 

- Filter a port range (Type 1): alert tcp any any <> any 1:1024   (msg: "TCP 1-1024 System Port Activity"; sid: 100001; rev:1;)
This rule will create an alert for each TCP packet sent to ports between 1-1024.

- Filter a port range (Type 2): alert tcp any any <> any :1024   (msg: "TCP 0-1024 System Port Activity"; sid: 100001; rev:1;)
This rule will create an alert for each TCP packet sent to ports less than or equal to 1024. 

- Filter a port range (Type 3): alert tcp any any <> any 1025: (msg: "TCP Non-System Port Activity"; sid: 100001; rev:1;)
This rule will create an alert for each TCP packet sent to source port higher than or equal to 1025. 

- Filter a port range (Type 4): alert tcp any any <> any [21,23] (msg: "FTP and Telnet Port 21-23 Activity Detected"; sid: 100001; rev:1;)
This rule will create an alert for each TCP packet sent to port 21 and 23. 

 
# Direction 
The direction operator indicates the traffic flow to be filtered by Snort. The left side of the rule shows the source, and the right side shows the destination.

-> Source to destination flow.
<> Bidirectional flow 

*Note: there is no "<-" operator in Snort. 


## Three Main rule options in Snort: 
1. General Rule Options - Fundamental rule options for Snort. 
2. Payload Rule Options - Rule options that help to investigate the payload data. These options are helpful to detect specific payload patterns.
3. Non-Payload Rule Options - Rule options that focus on non-payload data. These options will help create specific patterns and identify network issues. 

# 1. General Rule Options
- 1.1 Msg: The message field is a basic prompt and quick identifier of the rule. Once the rule is triggered, the message filed will appear in the console or log. Usually, the message part is a one-liner that summarises the event. 

- 1.2 Sid: (Snort rule IDs). This come with a pre-defined scope, and each rule must have a SID in a proper format. There are three different scopes for SIDs shown below.

<100: Reserved rules
100-999,999: Rules came with the build.
>=1,000,000: Rules created by user.

The rules I will create should have sid greater than 100.000.000, and each id must be unique.  

- 1.3 Reference: Each rule can have additional information or reference to explain the purpose of the rule or threat pattern. That could be a Common Vulnerabilities and Exposures (CVE) id or external information. Having references for the rules will always help analysts during the alert and incident investigation. 

- 1.4 Rev: Rev option help analysts to have the revision information of each rule as snort rules can be modified and updated for performance and efficiency issues. Therefore, it will be easy to understand rule improvements. Each rule has its unique rev number, and there is no auto-backup feature on the rule history. Analysts should keep the rule history themselves. Rev option is only an indicator of how many times the rule had revisions.

alert icmp any any <> any any (msg: "ICMP Packet Found"; sid: 100001; reference:cve,CVE-XXXX; rev:1;) 


# 2 Payload Detection Rule Options 
- 2.1 Content: Payload data. It matches specific payload data by ASCII, HEX or both. It is possible to use this option multiple times in a single rule. However, the more you create specific pattern match features, the more it takes time to investigate a packet.

Following rules will create an alert for each HTTP packet containing the keyword "GET". This rule option is case sensitive!

ASCII mode - alert tcp any any <> any 80  (msg: "GET Request Found"; content:"GET"; sid: 100001; rev:1;)
HEX mode - alert tcp any any <> any 80  (msg: "GET Request Found"; content:"|47 45 54|"; sid: 100001; rev:1;) 

- 2.2 Nocase: Disabling case sensitivity. Used for enhancing the content searches.
alert tcp any any <> any 80  (msg: "GET Request Found"; content:"GET"; nocase; sid: 100001; rev:1;) 

- 2.3 Fast_pattern: Prioritise content search to speed up the payload search operation. By default, Snort uses the biggest content and evaluates it against the rules. "fast_pattern" option helps user select the initial packet match with the specific value for further investigation. This option always works case insensitive and can be used once per rule. 

* Note: this option is required when using multiple "content" options. 

The following rule has two content options, and the fast_pattern option tells to snort to use the first content option (in this case, "GET") for the initial packet match.

alert tcp any any <> any 80  (msg: "GET Request Found"; content:"GET"; fast_pattern; content:"www";  sid:100001; rev:1;) 


# 3 Non-Payload Detection Options: 
These options below will help create specific patterns and identify network issues. 

- 3.1 ID: Filtering the IP id field.
alert tcp any any <> any any (msg: "ID TEST"; id:123456; sid: 100001; rev:1;) 

- 3.2 Flags: Filtering the TCP flags.

F - FIN
S - SYN
R - RST
P - PSH
A - ACK
U - URG
 
alert tcp any any <> any any (msg: "FLAG TEST"; flags:S;  sid: 100001; rev:1;)

- 3.3 Dsize: Filtering the packet payload size.

dsize:min<>max;
dsize:>100
dsize:<100
alert ip any any <> any any (msg: "SEQ TEST"; dsize:100<>300;  sid: 100001; rev:1;) 


- 3.4 Sameip: Filtering the source and destination IP addresses for duplication.
alert ip any any <> any any (msg: "SAME-IP TEST";  sameip; sid: 100001; rev:1;) 


# Note
1. Once a rule is created, it is a local rule and should be in the "local.rules" file. This file is located under "/etc/snort/rules/local.rules". 

2. There are some default rules activated with snort instance and theey are deactivated for now to manage my rules and improve exercise experience.  

 

## Lab 
Use the attached VM and navigate to the Task-Exercises/Exercise-Files/TASK-9 folder to answer the questions

Q1. Use "task9.pcap". Write a rule to filter IP ID "35369" and run it against the given pcap file. What is the request name of the detected packet? You may use this command: "snort -c local.rules -A full -l . -r task9.pcap" 
A1. TIMESTAMP REQUEST 

* This is what I did: 
1. First Navigated to /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9 in a terminal. 
2. Then I needed to write a new rue to filter IP ID "35369". 
2.1 To do that, I first executed this command to open/edit the local.rules file: sudo nano /etc/snort/rules/local.rules. After I ran the command, I saw this below.
(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 7.45.54 PM.png)


2.2 I wrote a new rule, which is: 
"alert ip any any <> any any (msg: "IP ID 35369 Detected"; id:35369; sid:100001; rev:1;)"
to filter IP ID "35369". 
Then I presssed option + O to save and option + X to exit. 

3. Then I ran snort with this configuration. 
Command: "snort -c /etc/snort/snort.conf -A full -l . -r task9.pcap" 

It is to tell Snort to analyze the task9.pcap file offline using the given configuration. It will detect any traffic that matches Snort rules and log the alerts (in full detail) to the current directory.


4. Then used this command: "cat alert" and checked the alert file in the TASK-9 directory. 
(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 8.09.34 PM.png)

5. I searched for ID 35369 from the output, and found that the reqest name of the detected packet is TIMESTAMP REQUEST 
(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 8.13.00 PM.png)

 



Q2. Clear the previous alert file and comment out the old rules. Create a rule to filter packets with Syn flag and run it against the given pcap file. What is the number of detected packets?
A2. 1

* This is what I did: 
1. Execute these commands: 
rm alert
rm -r log/
to clear the previous alert file. 

2. Just like how I did Q1, I navigated to /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9 in a terminal and executed this command to open/edit the local.rules file: "sudo nano /etc/snort/rules/local.rules".

3. Then I commented out the old rule with # and wrote a new rule (a rule to filter packets with Syn flag) below.
"alert tcp any any <> any any (msg: "SYN Packet Detected"; flags:S; sid:100002; rev:1;)"
Pressed control+O to save and control+X to exit. 
(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 8.20.53 PM.png)

4. I ran this command in /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9 : "snort -c /etc/snort/snort.conf -A full -l . -r task9.pcap" to run Snort in a changed configuration. 


5. Then I used this command: "cat alert" and checked the alert file in the TASK-9 directory.

6. I needed to count all alerts that said  "SYN Packet Detected", so I ran this command : "grep "SYN Packet Detected" alert | wc -l" in /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9. 

* 'wc -l' counts the number of lines that "SYN Packet Detected" appeared. 

Then I figured out that "SYN Packet Detected" appeared one time, and which meant only one packet that had Syn flag was filtered. 

(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 8.30.02 PM.png)






Q3. Clear the previous alert file and comment out the old rules. Write a rule to filter packets with Push-Ack flags and run it against the given pcap file. What is the number of detected packets?
A3. 216

* This is what I did: 
1. Execute these commands: 
rm alert
rm -r log/
to clear the previous alert file. 

2. Then just like how I did Q1&Q2, I navigated to /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9 in a terminal and executed this command to open/edit the local.rules file: "sudo nano /etc/snort/rules/local.rules".

3. Then I commented out the old rule with # and wrote a new rule (a rule to filter packets with Push-Ack flag) below.
"alert tcp any any <> any any (msg: "Push-Ack Packet Detected"; flags:PA; sid:100003; rev:1;)"
Pressed control+O to save and control+X to exit. 

(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 8.59.46 PM.png) 


3. Next, I ran this command : "snort -c /etc/snort/snort.conf -A full -l . -r task9.pcap" in /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/
TASK-9 to run Snort in a changed configuration.

4. Then I used this command: "cat alert" and checked the alert file in the TASK-9 directory.

5. I needed to count all alerts that said  "Push-Ack Packet Detected", so I ran this command : "grep "Push-Ack Packet Detected" alert | wc -l" in /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9. 

Then I figured out that "Push-Ack Packet Detected" appeared 216 times, and which meant 216 packet that had Push-Ack flags were filtered. 

(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 9.03.41 PM.png)




Q4. Clear the previous alert file and comment out the old rules. Create a rule to filter UDP packets with the same source and destination IP and run it against the given pcap file. What is the number of packets that show the same source and destination address?
A4. 


* This is what I did: 
1. Execute these commands: 
rm alert
rm -r log/
to clear the previous alert file. 

2. Then just like how I did Q1&Q2&Q3, I navigated to /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/TASK-9 in a terminal and executed this command to open/edit the local.rules file: "sudo nano /etc/snort/rules/local.rules".

3. Then I commented out the old rule with # and wrote a new rule (a rule to filter packets with UDP packets with the same source and destination IP) below.
"alert ip any any <> any any (msg: "Same Source-Destination IP Detected"; sameip; sid:100004; rev:1;)"
Pressed control+O to save and control+X to exit. 

(View image: Screenshots/Network Security and Traffic Analysis/02/2.9/Screenshot 2025-07-20 at 9.14.36 PM.png) 


3. Next, I ran this command : "snort -c /etc/snort/snort.conf -A full -l . -r task9.pcap" in /home/ubuntu/Desktop/Task-Exercises/Exercise-Files/
TASK-9 to run Snort in a changed configuration.

4. Then I used this command: "cat alert" and checked the alert file in the TASK-9 directory.

5. I needed to count all alerts that said  "Same Source-Destination IP Detected", but this time, I had to distinguish the only valid alerts so I needed to read all the lines that had  "Same Source-Destination IP Detected".  

To do that, I ran this command: "grep -A 5 "Same Source-Destination IP Detected" alert > alerts_to_check.txt" in a terminal (in ~TASK-9) to collect lines that I had to check. 

* -A 5: this tells grep to also include 5 lines after each match. It was necessary because Snort alerts are often multi-line.  

and checked the file content with 
"cat alerts_to_check.txt" 

Then I got this output below: 
alerts_to_check.txt

Then I figured out that the number of packets with the same source and destination IP is seven. 
 



Q5. Case Example - An analyst modified an existing rule successfully. Which rule option must the analyst change after the implementation?
A5. rev

The answer is rev beause it is an option that helps analysts to have the revision information of each rule as snort rules can be modified and updated for performance and efficiency issues. This aligns with the question that an analyst must change after modifying an existing rule. 


# From this lab, I learned.. 
1. How to write and test custom Snort rules.
I learned that I can create my own Snort rules using a simple structure like alert tcp any any -> any 80 (...), and save them in a custom rule file. 
After adding a rule, I can use snort -T -c to test it before actually running it. This helps avoid errors and makes rule creation feel more manageable.

2. How to detect specific packet characteristics using rule options.
Using options like flags:S, flags:PA, or id:xxxx, I was able to match packets based on TCP flags or IP ID values. This showed me that Snort can detect patterns beyond just payload content — it can also analyze low-level packet behavior.

3. How to identify unusual traffic patterns like same source and destination IP. 
I used the sameip option to detect traffic where the source and destination IP were the same. It helped me recognize that Snort can be used to catch weird or suspicious traffic patterns that may point to scanning, misconfiguration, or spoofing.

4. The importance of rule metadata like sid and rev.
Every rule needs a unique sid, and when a rule changes, the rev number should increase. This seems small but is super important when writing or maintaining custom rule sets — especially in team environments or automated deployments.

5. How to analyze alert logs and extract useful information.
After triggering alerts, I used grep and wc -l to count matches, and grep -A 5 to pull extra context. This helped me practice real-world log analysis skills, and I learned how to quickly find and understand what Snort detected without digging through every line manually. 